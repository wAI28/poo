<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탕탕특공대 샷건 v.1</title>
<style>
  body { margin:0; overflow:hidden; background:#222; }
  canvas { display:block; touch-action:none; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// 버전
const VERSION = "v.1";

// 맵 크기
const map = { width: canvas.width*5, height: canvas.height*5 };

// 플레이어
const player = { x: map.width/2, y: map.height/2, radius:20, color:"white", speed:5 };

let bullets = [];
let lastShot = 0;

// 조이스틱
const joystick = { x:0, y:0, stickX:0, stickY:0, radius:50, active:false, vx:0, vy:0 };

// 풀 생성 1200개
const grass = [];
for(let i=0;i<1200;i++){
  grass.push({ x: Math.random()*map.width, y: Math.random()*map.height, size:3 + Math.random()*4, color: Math.random()>0.5 ? "#7cfc00" : "#adff2f" });
}

let mapOffset = {x: canvas.width/2 - player.x, y: canvas.height/2 - player.y};

// 터치 이벤트
canvas.addEventListener("touchstart", e => {
  const t = e.touches[0];
  joystick.active = true;
  joystick.x = t.clientX; joystick.y = t.clientY;
  joystick.stickX = t.clientX; joystick.stickY = t.clientY;
});
canvas.addEventListener("touchmove", e => {
  if(!joystick.active) return;
  const t = e.touches[0];
  const dx = t.clientX - joystick.x, dy = t.clientY - joystick.y;
  const dist = Math.hypot(dx, dy), max = joystick.radius;
  if(dist>max){ joystick.stickX = joystick.x + dx/dist*max; joystick.stickY = joystick.y + dy/dist*max; }
  else { joystick.stickX = t.clientX; joystick.stickY = t.clientY; }
  joystick.vx = (joystick.stickX - joystick.x)/max*player.speed;
  joystick.vy = (joystick.stickY - joystick.y)/max*player.speed;
});
canvas.addEventListener("touchend", e => {
  joystick.active = false; joystick.vx=0; joystick.vy=0;
  joystick.stickX=joystick.x; joystick.stickY=joystick.y;
});

// 게임 루프
function update(){
  // 플레이어 이동 제한
  const nextX = player.x + joystick.vx;
  const nextY = player.y + joystick.vy;
  if(nextX - player.radius >= 0 && nextX + player.radius <= map.width) player.x = nextX;
  if(nextY - player.radius >= 0 && nextY + player.radius <= map.height) player.y = nextY;

  mapOffset.x = canvas.width/2 - player.x;
  mapOffset.y = canvas.height/2 - player.y;

  // 샷건 발사
  const now = Date.now();
  if(joystick.active && now - lastShot > 1000){
    const baseAngle = Math.atan2(joystick.stickY - joystick.y, joystick.stickX - joystick.x);
    const spread = 0.2;
    const count = 5;
    for(let i=0;i<count;i++){
      const angle = baseAngle - spread/2 + (spread/(count-1))*i;
      bullets.push({ x: player.x, y: player.y, dx: Math.cos(angle)*10, dy: Math.sin(angle)*10, size:10, trail:[] });
    }
    lastShot = now;
  }

  // 총알 이동 + 잔상
  bullets.forEach(b=>{
    b.trail.push({x:b.x, y:b.y});
    if(b.trail.length>5) b.trail.shift();
    b.x += b.dx; b.y += b.dy;
  });

  bullets = bullets.filter(b=>b.x>0 && b.x<map.width && b.y>0 && b.y<map.height);
}

function draw(){
  // 초록색 바닥
  ctx.fillStyle="#228B22";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // 풀
  grass.forEach(g=>{
    ctx.fillStyle=g.color;
    ctx.beginPath();
    ctx.arc(g.x+mapOffset.x, g.y+mapOffset.y, g.size/2,0,Math.PI*2);
    ctx.fill();
  });

  // 맵 테두리
  ctx.strokeStyle="white"; ctx.lineWidth=4;
  ctx.strokeRect(mapOffset.x, mapOffset.y, map.width, map.height);

  // 플레이어
  ctx.fillStyle=player.color;
  ctx.beginPath();
  ctx.arc(player.x+mapOffset.x, player.y+mapOffset.y, player.radius,0,Math.PI*2);
  ctx.fill();

  // 총알 + 잔상 (총알보다 항상 작은 잔상, 뒤로 갈수록 작고 투명)
  bullets.forEach(b=>{
    const trailLen = b.trail.length;
    b.trail.forEach((t,i)=>{
      const ratio = (i+1)/trailLen; 
      const scale = 0.2 + 0.6*ratio; 
      const alpha = 0.2 + 0.5*ratio; 
      ctx.fillStyle = `rgba(255,165,0,${alpha})`;
      ctx.beginPath();
      ctx.arc(t.x+mapOffset.x, t.y+mapOffset.y, (b.size/2)*scale,0,Math.PI*2);
      ctx.fill();
    });
    ctx.fillStyle="orange";
    ctx.beginPath();
    ctx.arc(b.x+mapOffset.x, b.y+mapOffset.y, b.size/2,0,Math.PI*2);
    ctx.fill();
  });

  // 조이스틱
  if(joystick.active){
    ctx.strokeStyle="#888"; ctx.lineWidth=4;
    ctx.beginPath();
    ctx.arc(joystick.x, joystick.y, joystick.radius,0,Math.PI*2);
    ctx.stroke();
    ctx.fillStyle="#555";
    ctx.beginPath();
    ctx.arc(joystick.stickX, joystick.stickY,25,0,Math.PI*2);
    ctx.fill();
  }

  // 화면 상단 중앙 버전 표시
  ctx.fillStyle = "white";
  ctx.font = "20px Arial";
  ctx.textAlign = "center";
  ctx.fillText(VERSION, canvas.width/2, 30);
  ctx.textAlign = "start";
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
