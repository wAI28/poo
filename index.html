<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>탕탕특공대 v13</title>
<style>
  body { margin:0; overflow:hidden; background:#0a0; }
  canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let v = "v13";
let keys = {};
let mouse = {x:0, y:0, down:false};

class Weapon {
  constructor(obj){
    Object.assign(this, obj);
    this.reloadTimeLeft = 0;
  }
}
const weapons = [
  new Weapon({name:"Shotgun", type:"spread", damage:1, bulletsPerShot:5, clip:5, reloadTime:1000, speed:10, trail:true}),
  new Weapon({name:"Rifle", type:"auto", damage:0.2, bulletsPerShot:1, clip:30, reloadTime:1500, fireRate:200, speed:15, trail:true})
];

let player = {
  x:canvas.width/2, y:canvas.height/2, size:20, color:"white",
  weaponIndex:0,
  weapon:weapons[0],
  currentAmmo:weapons[0].clip,
  reloading:false,
  level:1,
  exp:0,
  shotgunUpgradeLevel:0
};

let bullets = [];
let enemies = [];
let expObjs = [];

let lastFire = 0;
let lastRifleFire = 0;

// 레벨업 카드
let levelUp = false;
let cardOptions = [];

function fireWeapon(targetX, targetY){
  if(player.reloading) return;
  let w = player.weapon;
  if(player.currentAmmo <=0){
    player.reloading = true;
    w.reloadTimeLeft = w.reloadTime;
    return;
  }

  if(w.type === "spread"){
    for(let i=0;i<w.bulletsPerShot;i++){
      let angle = Math.atan2(targetY-player.y, targetX-player.x) + (Math.random()-0.5)*0.05;
      bullets.push({x:player.x, y:player.y, dx:Math.cos(angle)*w.speed, dy:Math.sin(angle)*w.speed, size:5, trail:[], damage:w.damage, knockback:15});
    }
  } else if(w.type==="auto"){
    if(Date.now()-lastRifleFire < w.fireRate) return;
    lastRifleFire = Date.now();
    let angle = Math.atan2(targetY-player.y, targetX-player.x) + (Math.random()-0.5)*0.2;
    bullets.push({x:player.x, y:player.y, dx:Math.cos(angle)*w.speed, dy:Math.sin(angle)*w.speed, size:5, trail:[], damage:w.damage, knockback:5});
  }
  player.currentAmmo--;
  if(player.currentAmmo <=0){
    player.reloading = true;
    w.reloadTimeLeft = w.reloadTime;
  }
}

function update(dt){
  // 무기 재장전
  let w = player.weapon;
  if(player.reloading){
    w.reloadTimeLeft -= dt;
    if(w.reloadTimeLeft <=0){
      player.reloading=false;
      player.currentAmmo = w.clip;
    }
  }

  // 총알 이동
  bullets.forEach(b=>{
    b.trail.push({x:b.x, y:b.y, size:b.size});
    if(b.trail.length>5) b.trail.shift();
    b.x+=b.dx;
    b.y+=b.dy;
  });

  // 경험치 이동
  expObjs.forEach(e=>{
    let dx = player.x - e.x;
    let dy = player.y - e.y;
    let dist = Math.hypot(dx,dy);
    if(dist<150){
      e.vx = dx*0.05;
      e.vy = dy*0.05;
    } else {
      e.vx = 0; e.vy=0;
    }
    e.x += e.vx;
    e.y += e.vy;
    if(dist<20){
      player.exp++;
      expObjs.splice(expObjs.indexOf(e),1);
    }
  });

  // 간단 적 스폰 (무제한)
  if(Math.random()<0.02){
    let ex = Math.random()*canvas.width;
    let ey = Math.random()*canvas.height;
    enemies.push({x:ex, y:ey, size:15, color:"red", hp:5});
  }

  // 적 이동
  enemies.forEach(e=>{
    let dx = player.x - e.x;
    let dy = player.y - e.y;
    let dist = Math.hypot(dx,dy);
    if(dist>0){
      e.x += dx/dist*1;
      e.y += dy/dist*1;
    }
  });

  // 총알과 적 충돌
  bullets.forEach(b=>{
    enemies.forEach(e=>{
      let dx = e.x - b.x;
      let dy = e.y - b.y;
      let dist = Math.hypot(dx,dy);
      if(dist<e.size){
        e.hp -= b.damage;
        e.x += -b.dx*0.5; e.y += -b.dy*0.5; // 넉백
        bullets.splice(bullets.indexOf(b),1);
      }
    });
  });

  // 죽은 적 경험치 드롭
  enemies = enemies.filter(e=>{
    if(e.hp<=0){
      for(let i=0;i<2+Math.floor(Math.random()*2);i++){
        expObjs.push({x:e.x, y:e.y, vx:0, vy:0, color:"yellow", size:7});
      }
      return false;
    }
    return true;
  });

  // 레벨업 체크
  if(player.exp >= 10*player.level && !levelUp){
    levelUp = true;
    player.exp=0;
    cardOptions = ["Upgrade","NewWeapon"];
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 배경
  ctx.fillStyle="#0a0"; ctx.fillRect(0,0,canvas.width,canvas.height);

  // 경험치
  expObjs.forEach(e=>{
    ctx.fillStyle=e.color;
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
    ctx.fill();
  });

  // 적
  enemies.forEach(e=>{
    ctx.fillStyle=e.color;
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.size,0,Math.PI*2);
    ctx.fill();
  });

  // 총알 잔상
  bullets.forEach(b=>{
    for(let i=0;i<b.trail.length;i++){
      let t = b.trail[i];
      ctx.fillStyle=`rgba(255,255,0,${0.2*(i+1)})`;
      let s = b.size*(0.5 + i*0.1);
      ctx.beginPath();
      ctx.arc(t.x,t.y,s,0,Math.PI*2);
      ctx.fill();
    }
    ctx.fillStyle="yellow";
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.size,0,Math.PI*2);
    ctx.fill();
  });

  // 플레이어
  ctx.fillStyle=player.color;
  ctx.beginPath();
  ctx.arc(player.x,player.y,player.size,0,Math.PI*2);
  ctx.fill();

  // UI 우측 하단
  let uiX = canvas.width-200, uiY=canvas.height-100;
  // 체력
  ctx.fillStyle="red"; ctx.fillRect(uiX,uiY,100,10);
  // 레벨
  ctx.fillStyle="yellow"; ctx.fillRect(uiX,uiY+20,player.exp*10,10);
  // 레벨 텍스트
  ctx.fillStyle="white"; ctx.font="16px Arial";
  ctx.fillText(`${player.level}lv`,uiX-50,uiY+30);
  // 무기 + 탄환
  ctx.fillText(`${player.weapon.name} ${player.currentAmmo}`,uiX,uiY-20);
  if(player.reloading) ctx.fillText("RELOADING",uiX,uiY-40);

  // 버전 표시 중앙 상단
  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.textAlign="center";
  ctx.fillText(v,canvas.width/2,30);

  // 레벨업 카드
  if(levelUp){
    ctx.fillStyle="rgba(0,0,0,0.7)";
    ctx.fillRect(canvas.width/2-150,canvas.height/2-100,300,200);
    ctx.fillStyle="white";
    ctx.fillText("1) Upgrade",canvas.width/2,canvas.height/2-30);
    ctx.fillText("2) New Weapon",canvas.width/2,canvas.height/2+30);
  }
}

canvas.addEventListener('click', e=>{
  if(levelUp){
    if(e.clientY<canvas.height/2) upgradeShotgun();
    else player.weaponIndex=1, player.weapon=weapons[1], player.currentAmmo=player.weapon.clip;
    levelUp=false;
  } else fireWeapon(e.clientX,e.clientY);
});

function upgradeShotgun(){
  if(player.weapon.name !== "Shotgun") return;
  if(player.shotgunUpgradeLevel<4){
    player.weapon.bulletsPerShot +=2;
    player.weapon.clip = player.weapon.bulletsPerShot;
    player.shotgunUpgradeLevel++;
  }
  player.currentAmmo = player.weapon.clip;
}

let lastTime = Date.now();
function gameLoop(){
  let now = Date.now();
  let dt = now - lastTime;
  lastTime = now;
  update(dt);
  draw();
  requestAnimationFrame(gameLoop);
}
gameLoop();
</script>
</body>
</html>
